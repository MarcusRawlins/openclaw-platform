generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant model: Each golf course is a tenant
model Course {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  address     String
  city        String
  state       String
  zipCode     String
  phone       String
  email       String
  website     String?
  logoUrl     String?
  
  // Stripe Connect
  stripeAccountId String? @unique
  stripeOnboarded Boolean @default(false)
  
  // Features enabled
  enablePasses    Boolean @default(true)
  enableGiftCards Boolean @default(true)
  enableLessons   Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  users        User[]
  passes       Pass[]
  giftCards    GiftCard[]
  lessons      Lesson[]
  bookings     Booking[]
  transactions Transaction[]
  
  @@index([slug])
}

model User {
  id        String   @id @default(uuid())
  courseId  String
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(CUSTOMER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  purchases    Purchase[]
  bookings     Booking[]
  giftCardsSent     GiftCard[] @relation("sender")
  giftCardsReceived GiftCard[] @relation("recipient")
  
  @@index([courseId, email])
}

enum UserRole {
  CUSTOMER
  INSTRUCTOR
  STAFF
  ADMIN
  OWNER
}

// Digital passes (punch cards, unlimited, etc.)
model Pass {
  id          String     @id @default(uuid())
  courseId    String
  name        String
  description String?
  passType    PassType
  punchCount  Int?       // For punch cards (e.g., 10 rounds)
  validDays   Int?       // Validity period in days
  price       Int        // Price in cents
  active      Boolean    @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  course    Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  purchases Purchase[]
  
  @@index([courseId, active])
}

enum PassType {
  PUNCH_CARD      // 10-round pass, etc.
  UNLIMITED       // Unlimited for duration
  MONTHLY         // Monthly membership
  ANNUAL          // Annual membership
}

// Gift cards
model GiftCard {
  id           String   @id @default(uuid())
  courseId     String
  code         String   @unique
  amount       Int      // Amount in cents
  balance      Int      // Remaining balance in cents
  senderId     String?
  recipientId  String?
  recipientEmail String?
  recipientName  String?
  message      String?
  status       GiftCardStatus @default(ACTIVE)
  expiresAt    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  course      Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sender      User?         @relation("sender", fields: [senderId], references: [id])
  recipient   User?         @relation("recipient", fields: [recipientId], references: [id])
  transactions Transaction[]
  
  @@index([courseId, code])
  @@index([courseId, status])
}

enum GiftCardStatus {
  ACTIVE
  REDEEMED
  EXPIRED
}

// Lesson offerings
model Lesson {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  instructorId String
  duration    Int      // Duration in minutes
  price       Int      // Price in cents
  maxStudents Int      @default(1)
  active      Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  course   Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  bookings Booking[]
  
  @@index([courseId, active])
}

// Lesson bookings
model Booking {
  id         String        @id @default(uuid())
  courseId   String
  userId     String
  lessonId   String
  date       DateTime
  timeSlot   String        // e.g., "09:00-10:00"
  status     BookingStatus @default(PENDING)
  notes      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@index([courseId, date])
  @@index([userId])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// Purchase records (passes, gift cards)
model Purchase {
  id          String       @id @default(uuid())
  userId      String
  passId      String?
  giftCardId  String?
  amount      Int          // Amount paid in cents
  status      PurchaseStatus @default(PENDING)
  punchesUsed Int          @default(0)
  expiresAt   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  pass Pass? @relation(fields: [passId], references: [id])
  
  @@index([userId])
}

enum PurchaseStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

// Payment transactions
model Transaction {
  id              String            @id @default(uuid())
  courseId        String
  amount          Int               // Amount in cents
  platformFee     Int               // Platform fee in cents
  netAmount       Int               // Amount to course after fees
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  stripePaymentId String?
  giftCardId      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  course   Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  giftCard GiftCard? @relation(fields: [giftCardId], references: [id])
  
  @@index([courseId, createdAt])
}

enum TransactionType {
  PASS_PURCHASE
  GIFT_CARD_PURCHASE
  GIFT_CARD_REDEMPTION
  LESSON_BOOKING
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
